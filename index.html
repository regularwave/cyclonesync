<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="apple-touch-icon" href="img/CycloneSync.svg">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/keyrune@latest/css/keyrune.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mana-font@latest/css/mana.css">
    <link rel="stylesheet" href="style.css">

    <link rel="manifest" href="manifest.json">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <link rel="shortcut icon" type="image/svg" href="img/CycloneSync.svg">

    <title>CycloneSync</title>
</head>

<body>
    <div id="container" class="floatcontainer">
        <div id="content" class="content">
            <div id="top-row" class="top-row">
                <div class="tile-wrapper" id="tile-life">
                    <div class="manasymbol-container">
                        <i class="ms ss-foil ss-grad ms-ability-lifelink toprow-manasymbol-icon"></i>
                    </div>
                    <input class="quantity" id="life" min="0" max="999" value="40" type="number" readonly tabindex="-1">
                    <div class="spinner-btns">
                        <button class="plus" onclick="updateValue('life', 1)">&plus;</button>
                        <button class="minus" onclick="updateValue('life', -1)">&minus;</button>
                    </div>
                </div>
                <div class="tile-wrapper hidden" id="tile-tax">
                    <div class="manasymbol-container">
                        <i class="ss ss-foil ss-grad ss-cmd ss-5x toprow-manasymbol-icon"></i>
                    </div>
                    <input class="quantity" id="tax" min="0" max="999" value="0" type="number" readonly tabindex="-1">
                    <div class="spinner-btns">
                        <button class="plus" onclick="updateValue('tax', 1)">&plus;</button>
                        <button class="minus" onclick="updateValue('tax', -1)">&minus;</button>
                    </div>
                </div>
            </div>
            <div id="room-row" class="room-row hidden">
                <div class="room-qr-trigger" onclick="showRoomQR()">
                    <i class="ms ms-counter-brick"></i>
                    <span>QR</span>
                </div>

                <div id="remote-players-container" class="remote-players-grid">
                </div>

                <div class="room-exit-btn" onclick="leaveRoom()">
                    <i class="ss ss-foil ss-grad ss-bfz ss-2x"></i>
                </div>
            </div>
            <div class="tracker-grid">
                <div class="tile-wrapper hidden" id="tile-w">
                    <div class="manasymbol-container">
                        <i class="ms ms-w ms-fw manasymbol-icon"></i>
                    </div>
                    <input class="quantity" id="mana-w" min="0" max="999" value="0" type="number" readonly tabindex="-1">
                    <div class="spinner-btns">
                        <button class="plus" onclick="updateValue('mana-w', 1)">&plus;</button>
                        <button class="minus" onclick="updateValue('mana-w', -1)">&minus;</button>
                    </div>
                </div>
                <div class="tile-wrapper hidden" id="tile-u">
                    <div class="manasymbol-container">
                        <i class="ms ms-u manasymbol-icon"></i>
                    </div>
                    <input class="quantity" id="mana-u" min="0" max="999" value="0" type="number" readonly tabindex="-1">
                    <div class="spinner-btns">
                        <button class="plus" onclick="updateValue('mana-u', 1)">&plus;</button>
                        <button class="minus" onclick="updateValue('mana-u', -1)">&minus;</button>
                    </div>
                </div>
                <div class="tile-wrapper hidden" id="tile-b">
                    <div class="manasymbol-container">
                        <i class="ms ms-b manasymbol-icon"></i>
                    </div>
                    <input class="quantity" id="mana-b" min="0" max="999" value="0" type="number" readonly tabindex="-1">
                    <div class="spinner-btns">
                        <button class="plus" onclick="updateValue('mana-b', 1)">&plus;</button>
                        <button class="minus" onclick="updateValue('mana-b', -1)">&minus;</button>
                    </div>
                </div>
                <div class="tile-wrapper hidden" id="tile-r">
                    <div class="manasymbol-container">
                        <i class="ms ms-r ms-fw manasymbol-icon"></i>
                    </div>
                    <input class="quantity" id="mana-r" min="0" max="999" value="0" type="number" readonly tabindex="-1">
                    <div class="spinner-btns">
                        <button class="plus" onclick="updateValue('mana-r', 1)">&plus;</button>
                        <button class="minus" onclick="updateValue('mana-r', -1)">&minus;</button>
                    </div>
                </div>
                <div class="tile-wrapper hidden" id="tile-g">
                    <div class="manasymbol-container">
                        <i class="ms ms-g manasymbol-icon"></i>
                    </div>
                    <input class="quantity" id="mana-g" min="0" max="999" value="0" type="number" readonly tabindex="-1">
                    <div class="spinner-btns">
                        <button class="plus" onclick="updateValue('mana-g', 1)">&plus;</button>
                        <button class="minus" onclick="updateValue('mana-g', -1)">&minus;</button>
                    </div>
                </div>
                <div class="tile-wrapper hidden" id="tile-c">
                    <div class="manasymbol-container">
                        <i class="ms ms-c manasymbol-icon"></i>
                    </div>
                    <input class="quantity" id="mana-c" min="0" max="999" value="0" type="number" readonly tabindex="-1">
                    <div class="spinner-btns">
                        <button class="plus" onclick="updateValue('mana-c', 1)">&plus;</button>
                        <button class="minus" onclick="updateValue('mana-c', -1)">&minus;</button>
                    </div>
                </div>
            </div>
            <div class="controls-row">
                <button class="control-btn" id="btn-life" onclick="toggleLife()">
                    <i class="ms ss-foil ss-grad ms-ability-lifelink"></i>
                </button>
                <button class="control-btn disabled" id="btn-tax" onclick="toggleTax()">
                    <i class="ss ss-foil ss-grad ss-cmd"></i>
                </button>
                <button class="control-btn" id="btn-pips" oncontextmenu="return false;">
                    <i class="ms ss-foil ss-grad ms-watermark-colorpie"></i>
                </button>
                <button class="control-btn" id="btn-cmd" onclick="toggleCmdModal()">
                    <i class="ss ss-foil ss-grad ss-mic"></i>
                </button>
                <button class="control-btn" id="btn-connect" onclick="toggleConnectModal()">
                    <i class="ss ss-foil ss-grad ss-eoe"></i>
                </button>
                <button class="control-btn" id="btn-udlrswap" onclick="toggleUDLR()">
                    <div id="icon-udlrswap" class="udlr-wrapper">
                        <i class="ms ss-foil ss-grad ms-dfc-front"></i>
                        <span class="udlr-plus ss-foil ss-grad">&plus;</span>
                    </div>
                </button>
                <button class="control-btn" id="btn-awake" onclick="toggleWakeLock()">
                    <i class="ms ss-foil ss-grad ms-dfc-day"></i>
                </button>
                <button onclick="resetAll()" class="control-btn">
                    <i class="ms ss-foil ss-grad ms-ability-dfc"></i> <span class="reset-text">RESET</span>
                </button>
            </div>
        </div>
    </div>
    <div id="credits-modal" class="hidden modal-overlay">
        <div class="cmd-modal-content modal-content-fit">
            <h2>Credits & Legal</h2>
            <p>Background image:
                <br>
                <i class="ms ss-foil ss-grad ms-artist-nib"></i> <em>black and white clouds in the sky</em> illustration by Mikhail Tyrsyna
            </p>
            <p>Fonts:
                <br>
                <a href="https://github.com/andrewgioia/keyrune" target="_blank">Keyrune</a> and <a href="https://github.com/andrewgioia/Mana" target="_blank">Mana</a> fonts by <a href="https://andrewgioia.com/">Andrew Gioia</a> (SIL OFL 1.1)
                <br>
                Beleren font from Wizards of the Coast
            </p>
            <p class="legal-text">
                CycloneSync is unofficial Fan Content permitted under the Fan Content Policy. Not approved/endorsed by Wizards of the Coast. Portions of the materials used are property of Wizards of the Coast; those portions &copy; Wizards of the Coast LLC.
            </p>
            <button class="close-btn" onclick="toggleCredits()">CLOSE</button>
        </div>
    </div>
    <div id="pips-modal" class="hidden modal-overlay">
        <div class="cmd-modal-content">
            <h2>Mana Tile Visibility</h2>
            <p class="help-subtext">Choose which mana tiles are always shown and which ones are toggled by the &ensp;<i class="ms ss-foil ss-grad ms-watermark-colorpie"></i>&ensp; button.</p>

            <div class="pips-grid">
                <input type="checkbox" id="chk-white" class="pip-chk" value="white">
                <label for="chk-white" class="pip-label"><i class="ms ms-w ms-cost ms-2x"></i></label>

                <input type="checkbox" id="chk-blue" class="pip-chk" value="blue">
                <label for="chk-blue" class="pip-label"><i class="ms ms-u ms-cost ms-2x"></i></label>

                <input type="checkbox" id="chk-black" class="pip-chk" value="black">
                <label for="chk-black" class="pip-label"><i class="ms ms-b ms-cost ms-2x"></i></label>

                <input type="checkbox" id="chk-red" class="pip-chk" value="red">
                <label for="chk-red" class="pip-label"><i class="ms ms-r ms-cost ms-2x"></i></label>

                <input type="checkbox" id="chk-green" class="pip-chk" value="green">
                <label for="chk-green" class="pip-label"><i class="ms ms-g ms-cost ms-2x"></i></label>

                <input type="checkbox" id="chk-colorless" class="pip-chk" value="colorless">
                <label for="chk-colorless" class="pip-label"><i class="ms ms-c ms-cost ms-2x"></i></label>
            </div>

            <button class="close-btn" onclick="savePipsConfig()">SAVE & CLOSE</button>
        </div>
    </div>
    <div id="cmd-modal" class="hidden modal-overlay">
        <div class="cmd-modal-content">
            <h2>Commander Damage</h2>
            <div class="cmd-quarters">
                <div class="cmd-quarter">
                    <input type="text" id="name-p1" class="player-name" value="Player 1" placeholder="Name" oninput="savePlayerName(this)">
                    <div class="cmd-counters-vertical">
                        <div class="cmd-wrapper">
                            <input type="text" class="cmd-name-input" id="name-cmd-p1-c1" value="Commander 1" oninput="saveCmdName(this)">
                            <div class="cmd-counter-unit">
                                <input class="quantity cmd-qty" id="cmd-p1-c1" value="0" type="number" readonly tabindex="-1">
                                <div class="spinner-btns">
                                    <button class="plus" onclick="updateCmdValue('cmd-p1-c1', 1)">&plus;</button>
                                    <button class="minus" onclick="updateCmdValue('cmd-p1-c1', -1)">&minus;</button>
                                </div>
                            </div>
                        </div>
                        <div class="cmd-wrapper">
                            <input type="text" class="cmd-name-input" id="name-cmd-p1-c2" value="Commander 2" oninput="saveCmdName(this)">
                            <div class="cmd-counter-unit">
                                <input class="quantity cmd-qty" id="cmd-p1-c2" value="0" type="number" readonly tabindex="-1">
                                <div class="spinner-btns">
                                    <button class="plus" onclick="updateCmdValue('cmd-p1-c2', 1)">&plus;</button>
                                    <button class="minus" onclick="updateCmdValue('cmd-p1-c2', -1)">&minus;</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="cmd-quarter">
                    <input type="text" id="name-p2" class="player-name" value="Player 2" placeholder="Name" oninput="savePlayerName(this)">
                    <div class="cmd-counters-vertical">
                        <div class="cmd-wrapper">
                            <input type="text" class="cmd-name-input" id="name-cmd-p2-c1" value="Commander 1" oninput="saveCmdName(this)">
                            <div class="cmd-counter-unit">
                                <input class="quantity cmd-qty" id="cmd-p2-c1" value="0" type="number" readonly tabindex="-1">
                                <div class="spinner-btns">
                                    <button class="plus" onclick="updateCmdValue('cmd-p2-c1', 1)">&plus;</button>
                                    <button class="minus" onclick="updateCmdValue('cmd-p2-c1', -1)">&minus;</button>
                                </div>
                            </div>
                        </div>
                        <div class="cmd-wrapper">
                            <input type="text" class="cmd-name-input" id="name-cmd-p2-c2" value="Commander 2" oninput="saveCmdName(this)">
                            <div class="cmd-counter-unit">
                                <input class="quantity cmd-qty" id="cmd-p2-c2" value="0" type="number" readonly tabindex="-1">
                                <div class="spinner-btns">
                                    <button class="plus" onclick="updateCmdValue('cmd-p2-c2', 1)">&plus;</button>
                                    <button class="minus" onclick="updateCmdValue('cmd-p2-c2', -1)">&minus;</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="cmd-quarter">
                    <input type="text" id="name-p3" class="player-name" value="Player 3" placeholder="Name" oninput="savePlayerName(this)">
                    <div class="cmd-counters-vertical">
                        <div class="cmd-wrapper">
                            <input type="text" class="cmd-name-input" id="name-cmd-p3-c1" value="Commander 1" oninput="saveCmdName(this)">
                            <div class="cmd-counter-unit">
                                <input class="quantity cmd-qty" id="cmd-p3-c1" value="0" type="number" readonly tabindex="-1">
                                <div class="spinner-btns">
                                    <button class="plus" onclick="updateCmdValue('cmd-p3-c1', 1)">&plus;</button>
                                    <button class="minus" onclick="updateCmdValue('cmd-p3-c1', -1)">&minus;</button>
                                </div>
                            </div>
                        </div>
                        <div class="cmd-wrapper">
                            <input type="text" class="cmd-name-input" id="name-cmd-p3-c2" value="Commander 2" oninput="saveCmdName(this)">
                            <div class="cmd-counter-unit">
                                <input class="quantity cmd-qty" id="cmd-p3-c2" value="0" type="number" readonly tabindex="-1">
                                <div class="spinner-btns">
                                    <button class="plus" onclick="updateCmdValue('cmd-p3-c2', 1)">&plus;</button>
                                    <button class="minus" onclick="updateCmdValue('cmd-p3-c2', -1)">&minus;</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="cmd-quarter">
                    <input type="text" id="name-p4" class="player-name" value="Player 4" placeholder="Name" oninput="savePlayerName(this)">
                    <div class="cmd-counters-vertical">
                        <div class="cmd-wrapper">
                            <input type="text" class="cmd-name-input" id="name-cmd-p4-c1" value="Commander 1" oninput="saveCmdName(this)">
                            <div class="cmd-counter-unit">
                                <input class="quantity cmd-qty" id="cmd-p4-c1" value="0" type="number" readonly tabindex="-1">
                                <div class="spinner-btns">
                                    <button class="plus" onclick="updateCmdValue('cmd-p4-c1', 1)">&plus;</button>
                                    <button class="minus" onclick="updateCmdValue('cmd-p4-c1', -1)">&minus;</button>
                                </div>
                            </div>
                        </div>
                        <div class="cmd-wrapper">
                            <input type="text" class="cmd-name-input" id="name-cmd-p4-c2" value="Commander 2" oninput="saveCmdName(this)">
                            <div class="cmd-counter-unit">
                                <input class="quantity cmd-qty" id="cmd-p4-c2" value="0" type="number" readonly tabindex="-1">
                                <div class="spinner-btns">
                                    <button class="plus" onclick="updateCmdValue('cmd-p4-c2', 1)">&plus;</button>
                                    <button class="minus" onclick="updateCmdValue('cmd-p4-c2', -1)">&minus;</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button class="close-btn" onclick="toggleCmdModal()">CLOSE</button>
        </div>
    </div>
    <div id="connect-modal" class="hidden modal-overlay">
        <div class="cmd-modal-content modal-content-fit">
            <h2>CycloneSync PodConnect</h2>

            <div id="connect-step-1">
                <label class="help-subtext input-label">Your Name (1-12 chars)</label>
                <input type="text" id="conn-player-name" class="modal-input" placeholder="Your Name" minlength="1" maxlength="12" oninput="validateConnectionInputs()">

                <div class="divider-line"></div>

                <div class="connect-split-row">
                    <div class="connect-col-main">
                        <label class="help-subtext input-label">Room Name (5-20 chars)</label>
                        <input type="text" id="conn-room-code" class="modal-input room-code-input" placeholder="e.g. EDH-NIGHT" minlength="5" maxlength="20" oninput="validateConnectionInputs()" disabled>
                        <button class="control-btn" id="btn-join-room" onclick="joinRoom()" disabled>JOIN / CREATE</button>
                    </div>

                    <div class="connect-divider-vertical"></div>

                    <div class="connect-col-side">
                        <button class="control-btn btn-scan-qr" id="btn-scan-qr" onclick="startQRScan()" disabled>
                            <i class="ms ms-beleren ms-2x"></i>SCAN QR
                        </button>
                    </div>
                </div>

                <p id="conn-status" class="help-subtext mt-1">Enter a name to begin.</p>
            </div>

            <div id="connect-step-2" class="hidden text-center">
                <h3>Room: <span id="display-room-code"></span></h3>
                <div id="room-qr-display" class="qr-display-box"></div>
                <p class="help-subtext">Other players can scan this to join the same room!</p>
            </div>

            <button class="close-btn mt-1" onclick="toggleConnectModal()">CLOSE</button>
        </div>
    </div>

    <div id="qr-modal" class="hidden modal-overlay">
        <div class="cmd-modal-content modal-content-fit">
            <h2>Scan QR Code</h2>
            <div id="qr-reader" class="qr-reader-box"></div>
            <button class="close-btn" onclick="stopQRScan()">CANCEL</button>
        </div>
    </div>
    <div id="confirm-modal" class="hidden modal-overlay modal-topmost">
        <div class="cmd-modal-content modal-dialog-small">
            <h2 class="dialog-title">CycloneSync</h2>
            <p id="confirm-msg" class="dialog-message">Are you sure?</p>
            <div class="dialog-btn-row">
                <button class="close-btn btn-dialog btn-danger" id="confirm-yes">YES</button>
                <button class="close-btn btn-dialog" id="confirm-no">CANCEL</button>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="hidden modal-overlay modal-topmost">
        <div class="cmd-modal-content modal-dialog-small">
            <h2 class="dialog-title">CycloneSync</h2>
            <p id="alert-msg" class="dialog-message">Notification message.</p>
            <button class="close-btn btn-dialog-full" id="alert-ok">OK</button>
        </div>
    </div>
    <div id="help-modal" class="hidden modal-overlay">
        <div class="cmd-modal-content modal-content-help">
            <h2>Help & Info</h2>

            <div class="help-tabs">
                <button class="help-tab-btn active" onclick="switchHelpTab('help-icons')">Icons</button>
                <button class="help-tab-btn" onclick="switchHelpTab('help-basics')">Basics</button>
                <button class="help-tab-btn" onclick="switchHelpTab('help-multi')">PodConnect</button>
            </div>

            <div id="help-icons" class="help-tab-content">
                <div class="help-icon-row">
                    <i class="ms ss-foil ss-grad ms-ability-lifelink ms-2x"></i> <span>toggle life tracker tile</span>
                </div>
                <div class="help-icon-row">
                    <i class="ss ss-foil ss-grad ss-cmd ss-2x"></i> <span>toggle commander tax tracker tile</span>
                </div>
                <div class="help-icon-row">
                    <i class="ms ss-foil ss-grad ms-watermark-colorpie ms-2x"></i> <span>toggle mana tracker tiles</span>
                </div>
                <div class="help-icon-row">
                    <i class="ss ss-foil ss-grad ss-mic ss-2x"></i> <span>toggle commander damage tracker</span>
                </div>
                <div class="help-icon-row">
                    <i class="ss ss-foil ss-grad ss-eoe ss-2x"></i> <span>open PodConnect settings</span>
                </div>
                <div class="help-icon-row">
                    <span class="udlr-wrapper">
                        <i class="ms ss-foil ss-grad ms-dfc-front ms-2x"></i>
                        <span class="udlr-plus ss-foil ss-grad">&plus;</span>
                    </span>
                    <span>swap between up/down and left/right tap zones to change values</span>
                </div>
                <div class="help-icon-row">
                    <i class="ms ss-foil ss-grad ms-dfc-day ms-2x"></i> <span>screen wake lock enabled</span>
                </div>
                <div class="help-icon-row">
                    <i class="ms ms-dfc-night ms-2x"></i> <span>screen wake lock disabled</span>
                </div>
                <div class="help-icon-row">
                    <i class="ms ss-foil ss-grad ms-ability-dfc ms-2x"></i> <span>reset tracking tile values</span>
                </div>
            </div>

            <div id="help-basics" class="help-tab-content hidden">
                <p><strong>Adjusting Values:</strong> Tap the tile to change its value. By default, the top half increases and the bottom half decreases. Use the
                    <span class="udlr-wrapper inline-help-wrapper">
                        <i class="ms ss-foil ss-grad ms-dfc-front"></i>
                        <span class="udlr-plus ss-foil ss-grad">&plus;</span>
                    </span>
                    button to switch to left/right tap zones!
                </p>
                <p><strong>Mana Tiles:</strong> Tap the <i class="ms ss-foil ss-grad ms-watermark-colorpie ms-2x"></i> button to show or hide mana tracker tiles. <em>Long-press</em> the button to choose which specific tiles are always shown and which are toggled by the button.</p>
                <p><strong>Custom Names:</strong> You can tap on any name in the commander damage tracker window to edit them.</p>
            </div>

            <div id="help-multi" class="help-tab-content hidden">
                <p><strong>Your Name:</strong> You must enter a name to join a room (1 - 12 characters).</p>
                <p><strong>Join or Create a Room:</strong> Enter a 5+ character room name to create a new room or join an existing room. You can use the <em>SCAN QR</em> button to quickly join an existing room (check with another player and they can display their room's QR).</p>
                <p><strong>Life Total Syncing:</strong> A "room bar" will appear and show you the life total of the <strong>other</strong> players in the room and will remain synced as long as they're in the room. When you change your life total using your life tracker tile that value will sync and update on the other players' screens.</p>
                <p><strong>Idle Timeout:</strong> The app will automatically disconnect you if it's in the background, if the device is locked, or if you're idle for 30 or more minutes.</p>
            </div>

            <button class="close-btn mt-auto" onclick="toggleHelp()">CLOSE</button>
        </div>
    </div>
    <div id="share-modal" class="hidden modal-overlay">
        <div class="cmd-modal-content modal-content-fit">
            <h2>Share</h2>
            <div id="share-qr-display" class="qr-display-box"></div>
            <p>
                <a href="https://regularwave.github.io/cyclonesync/" target="_blank">https://regularwave.github.io/cyclonesync/</a>
            </p>
            <button class="close-btn" onclick="toggleShare()">CLOSE</button>
        </div>
    </div>
    <div id="sticky-footer">
        <span class="footer-link" onclick="toggleHelp()">
            <i class="ss ss-foil ss-grad ss-mb2"></i> <span class="footer-text">Help</span>
        </span>
        <span class="footer-separator">|</span>
        <span class="footer-link" onclick="toggleCredits()">
            <i class="ms ss-foil ss-grad ms-artist-nib"></i> <span class="footer-text">Credits</span>
        </span>
        <span class="footer-separator">|</span>
        <a href="https://github.com/regularwave/cyclonesync" target="_blank" class="footer-link">
            <i class="ss ss-foil ss-grad ss-emn"></i> <span class="footer-text">GitHub</span>
        </a>
        <span class="footer-separator">|</span>
        <span class="footer-link" onclick="toggleShare()">
            <i class="ss ss-foil ss-grad ss-plc"></i> <span class="footer-text">Share</span>
        </span>
    </div>
    <script type="module" src="script.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Registration Failed: ', err));
            });
        }
    </script>
</body>

</html>